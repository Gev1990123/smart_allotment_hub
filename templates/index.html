<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Smart Allotment Dashboard</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/styles.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<header>
    <h1>ðŸŒ± Smart Allotment Dashboard</h1>
</header>

<main>

    <!-- Device Picker -->
    <div class="device-selector">
        <label for="deviceSelect"><strong>Select Device:</strong></label>
        <select id="deviceSelect"></select>
    </div>

    <!-- Latest Reading Summary -->
    <div class="latest-box">
        <h2>Latest Reading</h2>
        <p id="latestOutput">Select a device...</p>
    </div>

    <!-- Chart Area -->
    <div class="chart-container">
        <canvas id="historyChart"></canvas>
    </div>

</main>

<script>
    // -----------------------------
    // Fetch list of devices
    // -----------------------------
    async function loadDevices() {
        const res = await fetch("/devices");
        const data = await res.json();

        const select = document.getElementById("deviceSelect");
        select.innerHTML = "";

        data.devices.forEach(device => {
            const opt = document.createElement("option");
            opt.value = device;
            opt.textContent = device;
            select.appendChild(opt);
        });

        // Load data for first device
        if (data.devices.length > 0) {
            loadLatest(data.devices[0]);
            loadHistory(data.devices[0]);
        }
    }

    document.getElementById("deviceSelect").addEventListener("change", e => {
        loadLatest(e.target.value);
        loadHistory(e.target.value);
    });


    // -----------------------------
    // Fetch latest reading
    // -----------------------------
    async function loadLatest(device_id) {
        const res = await fetch(`/latest/${device_id}`);
        const readings = await res.json();  // Expect array of {sensor_name, sensor_value, sensor_unit, sensor_type, timestamp}

        const out = document.getElementById("latestOutput");
        if (!Array.isArray(readings) || readings.length === 0) {
        out.textContent = "No data available.";
        return;
        }

        out.innerHTML = `
            <strong>Device:</strong> ${device_id}<br>
            ${readings.map(r => `
                <strong>${r.sensor_name}:</strong> ${r.sensor_value} ${r.unit || ''}<br>
            `).join('')}
            <small>${new Date(readings[0].timestamp).toLocaleString()}</small>
        `;
    }

    // -----------------------------
    // Chart.js Setup (empty chart)
    // -----------------------------
    const ctx = document.getElementById("historyChart").getContext("2d");
    const chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            scales: {
                x: { title: { display: true, text: "Time" } },
                y: { 
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: "Moisture (%) / Temp (Â°C)" }
                }, 
                y1: {  // Secondary axis for light
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: "Light (lux)" },
                    grid: { drawOnChartArea: false }
                }
            
            }
        }
    });

    // -----------------------------
    // Fetch history + update chart
    // -----------------------------
    async function loadHistory(device_id) {
        const res = await fetch(`/history/${device_id}?hours=24`);
        const data = await res.json();

        if (!Array.isArray(data)) return;

        // Get unique timestamps (sorted)
        const timestamps = [...new Set(data.map(r => r.timestamp))].sort();
        const times = timestamps.map(t => new Date(t).toLocaleTimeString());

        // Group readings by sensor_name
        const sensors = [...new Set(data.map(r => r.sensor_name))];
        const sensorData = {};
        sensors.forEach(sensor => {
        sensorData[sensor] = {};
        data.forEach(reading => {
            if (reading.sensor_name === sensor) {
                sensorData[sensor][reading.timestamp] = reading.sensor_value;
                }
            });
        });

        // Clear and rebuild datasets
        chart.data.labels = times;
        chart.data.datasets = [];

        const colors = ['#2e7d32', '#1976d2', '#ff9800'];  // Green (moisture), Blue (temp), Orange (light)
        const yAxes = ['y', 'y', 'y1'];  // First two on left, light on right

        sensors.forEach((sensor, i) => {
                const values = timestamps.map(ts => sensorData[sensor][ts] || null);
                chart.data.datasets.push({
                    label: `${sensor} (${data.find(r => r.sensor_name === sensor)?.unit || ''})`,
                    data: values,
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length] + '20',
                    yAxisId: yAxes[i % yAxes.length],
                    fill: false,
                    tension: 0.1
                });
            });

            chart.update('none');  // Fast update
            
    }   

 
    // Initial load
    loadDevices();

    </script>
   </body>
</html>