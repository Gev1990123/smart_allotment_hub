<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Smart Allotment Dashboard</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/styles.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Shared Scripts -->
    <script src="/static/js/scripts.js"></script>
</head>

<body>

<header>
    <h1>ğŸŒ± Smart Allotment Dashboard</h1>
</header>

<!-- NAVIGATION -->
<nav>
    <a href="/">ğŸ“Š Dashboard</a>
    <a href="/devices">ğŸ“¡ Devices</a>
    <a href="/sites">ğŸ“ Sites</a>
</nav>

<main>

    <!-- Device Picker -->
    <div class="page-selector">
        <label for="deviceSelect"><strong>Select Device:</strong></label>
        <select id="deviceSelect"></select>
    </div>

    <!-- Latest Reading Summary -->
    <div class="sensor-grid">
        <div class="sensor-card" data-type="temperature">
            <div class="sensor-icon">ğŸŒ¡ï¸</div>
            <div class="sensor-value" id="tempValue">--</div>
            <div class="sensor-label">Temperature</div>
            <div class="sensor-unit">Â°C</div>
        </div>
        <div class="sensor-card" data-type="moisture">
            <div class="sensor-icon">ğŸ’§</div>
            <div class="sensor-value" id="moistureValue">--</div>
            <div class="sensor-label">Soil Moisture</div>
            <div class="sensor-unit">%</div>
        </div>
        <div class="sensor-card" data-type="light">
            <div class="sensor-icon">â˜€ï¸</div>
            <div class="sensor-value" id="lightValue">--</div>
            <div class="sensor-label">Light</div>
            <div class="sensor-unit">lux</div>
        </div>
        <div class="sensor-card status">
            <div class="sensor-icon">ğŸ“¡</div>
            <div class="sensor-value" id="statusValue">Offline</div>
            <div class="sensor-label">Status</div>
            <div class="sensor-unit"></div>
        </div>
    </div>

    <!-- Chart Area -->
    <div class="charts-grid">
        <div class="chart-container">
            <h3>ğŸŒ¡ï¸ Temperature (Â°C)</h3>
            <canvas id="tempChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>ğŸ’§ Moisture (%)</h3>
            <canvas id="moistureChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>â˜€ï¸ Light (lux)</h3>
            <canvas id="lightChart"></canvas>
        </div>
    </div>

</main>

<script>
// ============================================
// DASHBOARD PAGE SPECIFIC JAVASCRIPT
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    // -----------------------------
    // Fetch list of devices
    // -----------------------------
    async function loadDevices() {
        try {
            const res = await fetch("/api/devices");
            const data = await res.json();

            const select = document.getElementById("deviceSelect");
            select.innerHTML = "";

            data.devices.forEach(device => {
                const opt = document.createElement("option");
                opt.value = device.uid;
                opt.textContent = device.name;
                select.appendChild(opt);
            });

            if (data.devices.length > 0) {
                loadLatest(data.devices[0].uid);  
                loadHistory(data.devices[0].uid);
            }
        } catch (e) {
            console.error("Failed to load devices:", e);
            // Fallback
            document.getElementById("deviceSelect").innerHTML = '<option value="SA-NODE1">SA-NODE1</option>';
            loadLatest("SA-NODE1");
            loadHistory("SA-NODE1");
        }
    }

    document.getElementById("deviceSelect").addEventListener("change", e => {
        const device_id = e.target.value;
        if (device_id) {
            loadLatest(device_id);
            loadHistory(device_id);
        }
    });

    // -----------------------------
    // Fetch latest reading
    // -----------------------------
    async function loadLatest(device_uid) {
        try {
            const res = await fetch(`/api/latest/${device_uid}`);
            const readings = await res.json();
            console.log("Latest readings:", readings); // DEBUG
            
            if (!Array.isArray(readings) || readings.length === 0) {
                document.getElementById("statusValue").textContent = "No Data";
                return;
            }

            // Direct mapping - find each sensor by type
            const tempReading = readings.find(r => r.sensor_type === 'temperature');
            const moistureReading = readings.find(r => r.sensor_type === 'moisture');
            const lightReading = readings.find(r => r.sensor_type === 'light');

            // Update each card directly
            document.getElementById("tempValue").textContent = 
                tempReading ? tempReading.sensor_value.toFixed(1) : "--";
            document.getElementById("moistureValue").textContent = 
                moistureReading ? moistureReading.sensor_value.toFixed(1) : "--";
            document.getElementById("lightValue").textContent = 
                lightReading ? lightReading.sensor_value.toFixed(1) : "--";
                
            document.getElementById("statusValue").textContent = 
                `Live - ${new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`;

        } catch (e) {
            console.error("Latest failed:", e);
            document.getElementById("statusValue").textContent = "Error";
        }
    }



    // -----------------------------
    // Create 3 separate charts
    // -----------------------------
    const tempCtx = document.getElementById("tempChart").getContext("2d");
    const moistureCtx = document.getElementById("moistureChart").getContext("2d"); 
    const lightCtx = document.getElementById("lightChart").getContext("2d");

    const tempChart = new Chart(tempCtx, {
        type: "line",
        data: { labels: [], datasets: [] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                x: { title: { display: true, text: "Time" } },
                y: { min: 10, max: 30, title: { display: true, text: "Â°C" } }
            }
        }
    });

    const moistureChart = new Chart(moistureCtx, {
        type: "line",
        data: { labels: [], datasets: [] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                x: { title: { display: true, text: "Time" } },
                y: { min: 0, max: 110, title: { display: true, text: "%" } }
            }
        }
    });

    const lightChart = new Chart(lightCtx, {
        type: "line",
        data: { labels: [], datasets: [] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                x: { title: { display: true, text: "Time" } },
                y: { min: 0, max: 1000, title: { display: true, text: "lux" } }
            }
        }
    });

    // Helper function
    function updateSingleChart(chart, times, timestamps, readings, type) {
        const values = timestamps.map(ts => {
            const reading = readings.find(r => r.timestamp === ts);
            return reading ? reading.sensor_value : null;
        });
        
        chart.data.labels = times;
        chart.data.datasets = [{
            label: type.charAt(0).toUpperCase() + type.slice(1),
            data: values,
            borderColor: type === 'light' ? '#ff9800' : type === 'temperature' ? '#2196f3' : '#4caf50',
            backgroundColor: type === 'light' ? '#ff980033' : type === 'temperature' ? '#2196f333' : '#4caf5033',
            fill: false,
            tension: 0.3,
            pointRadius: 3
        }];
        chart.update('none');
    }

    // -----------------------------
    // Fetch history + update charts
    // -----------------------------
    async function loadHistory(device_uid) {
        try {
            const res = await fetch(`/api/history/${device_uid}?hours=2`);
            const data = await res.json();
            if (!Array.isArray(data) || data.length === 0) return;

            const timestamps = [...new Set(data.map(r => r.timestamp))].slice(-30).sort();
            const times = timestamps.map(t => new Date(t).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));

            const tempReadings = data.filter(r => r.sensor_type === 'temperature');
            const moistureReadings = data.filter(r => r.sensor_type === 'moisture');
            const lightReadings = data.filter(r => r.sensor_type === 'light');

            updateSingleChart(tempChart, times, timestamps, tempReadings, 'temperature');
            updateSingleChart(moistureChart, times, timestamps, moistureReadings, 'moisture');
            updateSingleChart(lightChart, times, timestamps, lightReadings, 'light');
        } catch (e) {
            console.error("Failed to load history:", e);
        }
    }

    // Initial load
    loadDevices();
});
</script>


   </body>
</html>