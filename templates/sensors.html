<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Sensors - Smart Allotment</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/styles.css">
    
    <!-- Shared Scripts -->
    <script src="/static/js/scripts.js"></script>
</head>

<body>

<header>
    <h1>üå± Smart Allotment - Sensors</h1>
</header>

<!-- NAVIGATION -->
<nav>
    <div class="nav-links">
        <a href="/">üìä Dashboard</a>
        <a href="/devices">üì° Devices</a>
        <a href="/sites">üè° Sites</a>
        <a href="/sensors">üîß Sensors</a>
    </div>
    <div class="nav-user">
        <span class="user-info">
            <strong>{{ user.full_name or user.username }}</strong>
            {% if user.role == 'sys_admin' %}
            <span class="user-role-badge">Admin</span>
            {% endif %}
        </span>
        <button onclick="logout()" class="btn-secondary">Logout</button>
    </div>  
</nav>

<main>

    <!-- Page Header -->
    <div class="page-selector">
        <div style="flex: 1;">
            <h2 style="margin: 0; font-size: 20px;">üîß Sensor Management</h2>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Register and manage sensors for your devices</p>
        </div>
        
        <!-- Filter Controls -->
        <div style="display: flex; gap: 10px; align-items: center;">
            <select id="deviceFilter" onchange="filterSensors()">
                <option value="">All Devices</option>
            </select>
            <select id="statusFilter" onchange="filterSensors()">
                <option value="">All Status</option>
                <option value="active">Active Only</option>
                <option value="inactive">Inactive Only</option>
            </select>
        </div>
        
        {% if user.role == 'sys_admin' %}
        <button onclick="openAddSensorModal()" style="margin-right: 10px;">+ Register Sensor</button>
        {% endif %}
        <button onclick="window.location.href='/'">‚Üê Back to Dashboard</button>
    </div>

    <!-- Summary Stats -->
    <div class="sensor-grid" style="margin-bottom: 25px;">
        <div class="sensor-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="sensor-icon">üìä</div>
            <div class="sensor-value" id="totalSensors">--</div>
            <div class="sensor-label">Total Sensors</div>
        </div>
        <div class="sensor-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
            <div class="sensor-icon">‚úÖ</div>
            <div class="sensor-value" id="activeSensors">--</div>
            <div class="sensor-label">Active Sensors</div>
        </div>
        <div class="sensor-card" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);">
            <div class="sensor-icon">‚è∏Ô∏è</div>
            <div class="sensor-value" id="inactiveSensors">--</div>
            <div class="sensor-label">Inactive Sensors</div>
        </div>
        <div class="sensor-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="sensor-icon">üì°</div>
            <div class="sensor-value" id="devicesWithSensors">--</div>
            <div class="sensor-label">Devices</div>
        </div>
    </div>

    <!-- Sensors Table -->
    <div class="latest-box">
        <div id="sensorsTableContainer">
            <!-- Table will be loaded here -->
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="latest-box" style="text-align: center; display: none;">
        <p>Loading sensors...</p>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="latest-box" style="text-align: center; display: none;">
        <h3>No Sensors Found</h3>
        <p>No sensors have been registered yet.</p>
        {% if user.role == 'sys_admin' %}
        <button onclick="openAddSensorModal()" style="margin-top: 15px;">+ Register First Sensor</button>
        {% endif %}
    </div>

    <!-- Add/Edit Sensor Modal -->
    <div id="sensorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Register New Sensor</h3>
                <span class="modal-close" onclick="closeSensorModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="sensorForm">
                    <input type="hidden" id="sensorId" name="sensor_id">
                    
                    <div class="form-group">
                        <label for="sensorDevice">Device <span style="color: #e53935;">*</span></label>
                        <select id="sensorDevice" name="device_id" required>
                            <option value="">Loading devices...</option>
                        </select>
                        <small>Select the device this sensor is attached to</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="sensorName">Sensor ID/Name <span style="color: #e53935;">*</span></label>
                        <input type="text" id="sensorName" name="sensor_name" required 
                               placeholder="e.g., soil-sensor-001"
                               pattern="[A-Za-z0-9\-_]+"
                               title="Only letters, numbers, hyphens, and underscores allowed">
                        <small>Unique identifier for this sensor (must match hardware ID)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="sensorType">Sensor Type <span style="color: #e53935;">*</span></label>
                        <select id="sensorType" name="sensor_type" required onchange="updateUnitField()">
                            <option value="">Select type...</option>
                            <option value="moisture">Moisture</option>
                            <option value="temperature">Temperature</option>
                            <option value="light">Light</option>
                        </select>
                        <small>Type of measurement this sensor provides</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="sensorUnit">Unit</label>
                        <input type="text" id="sensorUnit" name="unit" 
                               placeholder="Auto-detected based on type">
                        <small>Measurement unit (automatically filled for common types)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="sensorNotes">Notes</label>
                        <textarea id="sensorNotes" name="notes" rows="3" 
                                  placeholder="e.g., Located in bed 1, north side"
                                  style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: inherit; font-size: 14px; box-sizing: border-box;"></textarea>
                        <small>Optional: Location, calibration info, or other details</small>
                    </div>
                    
                    <div id="formError" class="form-error" style="display: none;"></div>
                    <div id="formSuccess" class="form-success" style="display: none;"></div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeSensorModal()">Cancel</button>
                        <button type="submit" id="submitBtn">Register Sensor</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <span class="modal-close" onclick="closeDeleteModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Are you sure you want to delete this sensor?</p>
                <p style="color: #e53935; font-size: 14px; margin-top: 15px;">
                    <strong>‚ö†Ô∏è Warning:</strong> This action cannot be undone. Historical data will remain but the sensor will no longer be able to submit new readings.
                </p>
                <div class="modal-actions" style="margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                    <button type="button" onclick="confirmDelete()" style="background: #e53935;">Delete Sensor</button>
                </div>
            </div>
        </div>
    </div>

</main>

<script src="/static/js/sensors.js"></script>

</body>
</html>