<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Sites - Smart Allotment</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/styles.css">

    <!-- Shared Scripts -->
    <script src="/static/js/scripts.js"></script>
</head>

<body>

<header>
    <h1>üå± Smart Allotment - Sites</h1>
</header>

<!-- NAVIGATION -->
<nav>
    <div class="nav-links">
        <a href="/">üìä Dashboard</a>
        <a href="/devices">üì° Devices</a>
        <a href="/sites">üè° Sites</a>
    </div>
    <div class="nav-user">
        <span class="user-info">
            <strong>{{ user.full_name or user.username }}</strong>
            {% if user.role == 'sys_admin' %}
            <span class="user-role-badge">Admin</span>
            {% endif %}
        </span>
        <button onclick="logout()" class="btn-secondary">Logout</button>
    </div>  
</nav>

<main>

    <!-- Page Header -->
    <div class="page-selector">
        <div style="flex: 1;">
            <h2 style="margin: 0; font-size: 20px;">üìç Site Management</h2>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Monitor and manage all your sites</p>
        </div>
        {% if user.role == 'sys_admin' %}
        <button onclick="openAddSiteModal()" style="margin-right: 10px;">+ Add Site</button>
        {% endif %}
        <button onclick="window.location.href='/'">‚Üê Back to Dashboard</button>
    </div>

    <!-- Sites Grid -->
    <div id="sitesContainer" class="page-grid">
        <!-- Sites will be loaded here -->
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="latest-box" style="text-align: center;">
        <p>Loading sites...</p>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="latest-box" style="text-align: center; display: none;">
        <h3>No Sites Found</h3>
        <p>No sites have been registered yet.</p>
    </div>

    <!-- Add Site Modal -->
    <div id="addSiteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Site</h3>
                <span class="modal-close" onclick="closeAddSiteModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addSiteForm">
                    <div class="form-group">
                        <label for="siteCode">Site Code <span style="color: #e53935;">*</span></label>
                        <input type="text" id="siteCode" name="uid" required placeholder="e.g.,SITE-001">
                        <small>Site Code is a unique identifier for the site (required)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="friendlyName">Friendly Name<span style="color: #e53935;">*</span></label>
                        <input type="text" id="friendlyName" name="name" required placeholder="e.g., Greenhouse 1">
                        <small>Friendly name for the site (required)</small>
                    </div>
                    
                    <div id="formError" class="form-error" style="display: none;"></div>
                    <div id="formSuccess" class="form-success" style="display: none;"></div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeAddSiteModal()">Cancel</button>
                        <button type="submit" id="submitBtn">Add Site</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</main>

<script>
// ============================================
// SITES PAGE SPECIFIC JAVASCRIPT
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    
    // Load sites
    loadSites();
    
    // Auto-refresh every 30 seconds
    setInterval(loadSites, 30000);
});

async function loadSites() {
    const container = document.getElementById('sitesContainer');
    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    
    try {
        const res = await fetch('/api/sites');
        const data = await res.json();
        
        if (!data.sites || data.sites.length === 0) {
            container.style.display = 'none';
            loadingState.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }
        
        loadingState.style.display = 'none';
        emptyState.style.display = 'none';
        container.style.display = 'grid';
        
        renderSites(data.sites);
        
    } catch (e) {
        console.error('Failed to load sites:', e);
        loadingState.innerHTML = '<p style="color: #e53935;">Error loading sites. Please try again.</p>';
    }
}

function renderSites(sites) {
    const container = document.getElementById('sitesContainer');
    
    container.innerHTML = sites.map(site => {
        return `
            <div class="page-card">
                <div class="page-header">
                    <h3 class="page-name">${site.friendly_name}</h3>
                    <span class="site-code">${site.site_code}</span>
                </div>
            </div>
        `;
    }).join('');
            
        }
// ============================================
// ADD SITE MODAL FUNCTIONS
// ============================================
async function openAddSiteModal() {
    document.getElementById('addSiteModal').style.display = 'block';
    document.getElementById('addSiteForm').reset();
    document.getElementById('formError').style.display = 'none';
    document.getElementById('formSuccess').style.display = 'none';
}

function closeAddSiteModal() {
    document.getElementById('addSiteModal').style.display = 'none';
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('addSiteModal');
    if (event.target === modal) {
        closeAddSiteModal();
    }
}

// Handle form submission
document.getElementById('addSiteForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formError = document.getElementById('formError');
    const formSuccess = document.getElementById('formSuccess');
    const submitBtn = document.getElementById('submitBtn');
    
    // Hide previous messages
    formError.style.display = 'none';
    formSuccess.style.display = 'none';
    
    // Get form data
    const siteCode = document.getElementById('siteCode').value.trim();
    const friendlyName = document.getElementById('friendlyName').value.trim() || null;
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';
    
    try {
        const response = await fetch('/api/site/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                site_code: siteCode,
                friendly_name: friendlyName
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Success
            formSuccess.textContent = `Site "${friendlyName}" added successfully!`;
            formSuccess.style.display = 'block';
            
            // Refresh sites list
            setTimeout(() => {
                closeAddSiteModal();
                loadSites();
            }, 1500);
            
        } else {
            // Error from server
            formError.textContent = data.detail || 'Failed to add site';
            formError.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add Site';
        }
        
    } catch (error) {
        console.error('Error adding site:', error);
        formError.textContent = 'Network error. Please try again.';
        formError.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Site';
    }
});

</script>

</body>
</html>