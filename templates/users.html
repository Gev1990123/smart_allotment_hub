<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>User Management â€” Smart Allotment</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>

<header>
    <h1>ğŸŒ± Smart Allotment Dashboard</h1>
</header>

<nav>
    <div class="nav-links">
        <a href="/">ğŸ“Š Dashboard</a>
        <a href="/devices">ğŸ“¡ Devices</a>
        <a href="/sites">ğŸ¡ Sites</a>
        <a href="/sensors">ğŸ”§ Sensors</a>
        {% if user.role == 'sys_admin' %}
        <a href="/users" class="active">ğŸ‘¤ Users</a>
        {% endif %}
    </div>
    <div class="nav-user">
        <span class="user-info">
            <strong>{{ user.full_name or user.username }}</strong>
            {% if user.role == 'sys_admin' %}
            <span class="user-role-badge">Admin</span>
            {% endif %}
        </span>
        <button onclick="logout()" class="btn-secondary">Logout</button>
    </div>
</nav>

<main>
    <div class="users-header">
        <h2>ğŸ‘¤ User Management</h2>
        <button onclick="openCreateModal()">+ Add User</button>
    </div>

    <div class="users-table-wrap">
        <table class="users-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Full Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Sites</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <tr class="loading-row">
                    <td colspan="7">Loading usersâ€¦</td>
                </tr>
            </tbody>
        </table>
    </div>
</main>

<!-- ===================== CREATE / EDIT USER MODAL ===================== -->
<div class="modal" id="userModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="userModalTitle">Add User</h3>
            <span class="modal-close" onclick="closeUserModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="userFormError" class="form-error" style="display:none;"></div>
            <div id="userFormSuccess" class="form-success" style="display:none;"></div>

            <div class="form-row">
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="fieldUsername" placeholder="e.g. jsmith" autocomplete="off" />
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select id="fieldRole">
                        <option value="user">User</option>
                        <option value="sys_admin">System Admin</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="fieldFullName" placeholder="e.g. John Smith" />
            </div>

            <div class="form-group">
                <label>Email *</label>
                <input type="email" id="fieldEmail" placeholder="e.g. john@example.com" />
            </div>

            <div class="form-group" id="passwordGroup">
                <label id="passwordLabel">Password *</label>
                <input type="password" id="fieldPassword" placeholder="Enter password" autocomplete="new-password" />
                <p class="password-hint" id="passwordHint"></p>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeUserModal()">Cancel</button>
                <button id="userModalSaveBtn" onclick="saveUser()">Create User</button>
            </div>
        </div>
    </div>
</div>

<!-- ===================== SITE ASSIGNMENT MODAL ===================== -->
<div class="modal" id="siteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ¡ Manage Site Access</h3>
            <span class="modal-close" onclick="closeSiteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p id="siteModalDesc" style="color:#666;margin-top:0;"></p>
            <div id="siteFormError" class="form-error" style="display:none;"></div>

            <div class="sites-checklist" id="sitesChecklist">
                <!-- Populated dynamically -->
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeSiteModal()">Done</button>
            </div>
        </div>
    </div>
</div>

<!-- ===================== DELETE CONFIRM MODAL ===================== -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="color:#e53935;">âš ï¸ Delete User</h3>
            <span class="modal-close" onclick="closeDeleteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete <span class="danger-text" id="deleteUserName"></span>?</p>
            <p style="font-size:13px;color:#888;">This action cannot be undone. All site assignments for this user will also be removed.</p>
            <div id="deleteFormError" class="form-error" style="display:none;"></div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn-danger" onclick="confirmDelete()">Delete User</button>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/scripts.js"></script>
<script src="/static/js/user.js"></script>

</body>
</html>