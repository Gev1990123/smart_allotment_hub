<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Devices - Smart Allotment</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/styles.css">
    
    <!-- Shared Scripts -->
    <script src="/static/js/scripts.js"></script>
</head>

<body>

<header>
    <h1>üå± Smart Allotment - Devices</h1>
</header>

<!-- NAVIGATION SNIPPET -->
<nav>
    <a href="/">üìä Dashboard</a>
    <a href="/devices">üì° Devices</a>
    <a href="/sites">üìç Sites</a>
</nav>

<main>

    <!-- Page Header -->
    <div class="page-selector">
        <div style="flex: 1;">
            <h2 style="margin: 0; font-size: 20px;">üì° Device Management</h2>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Monitor and manage all your allotment sensors</p>
        </div>
        <button onclick="openAddDeviceModal()" style="margin-right: 10px;">+ Add Device</button>
        <button onclick="window.location.href='/'">‚Üê Back to Dashboard</button>
    </div>

    <!-- Devices Grid -->
    <div id="devicesContainer" class="page-grid">
        <!-- Devices will be loaded here -->
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="latest-box" style="text-align: center;">
        <p>Loading devices...</p>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="latest-box" style="text-align: center; display: none;">
        <h3>No Devices Found</h3>
        <p>No devices have been registered yet.</p>
    </div>

    <!-- Add Device Modal -->
    <div id="addDeviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Device</h3>
                <span class="modal-close" onclick="closeAddDeviceModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addDeviceForm">
                    <div class="form-group">
                        <label for="deviceUid">Device UID <span style="color: #e53935;">*</span></label>
                        <input type="text" id="deviceUid" name="uid" required 
                               placeholder="e.g., SA-NODE2" 
                               pattern="[A-Za-z0-9\-_]+"
                               title="Only letters, numbers, hyphens, and underscores allowed">
                        <small>Unique identifier for the device</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="deviceName">Device Name</label>
                        <input type="text" id="deviceName" name="name" 
                               placeholder="e.g., Garden Bed 1">
                        <small>Friendly name for the device (optional)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="siteId">Site ID</label>
                        <select id="siteId" name="site_id">
                            <option value="">Loading sites...</option>
                        </select>
                        <small>Associated site/location ID (optional)</small>
                    </div>
                    
                    <div id="formError" class="form-error" style="display: none;"></div>
                    <div id="formSuccess" class="form-success" style="display: none;"></div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeAddDeviceModal()">Cancel</button>
                        <button type="submit" id="submitBtn">Add Device</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</main>

<script>
// ============================================
// DEVICES PAGE SPECIFIC JAVASCRIPT
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    // Load devices
    loadDevices();
    
    // Auto-refresh every 30 seconds
    setInterval(loadDevices, 30000);
});

async function loadDevices() {
    const container = document.getElementById('devicesContainer');
    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    
    try {
        const res = await fetch('/api/devices');
        const data = await res.json();
        
        if (!data.devices || data.devices.length === 0) {
            container.style.display = 'none';
            loadingState.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }
        
        loadingState.style.display = 'none';
        emptyState.style.display = 'none';
        container.style.display = 'grid';
        
        // Fetch latest data for each device to determine status
        const devicesWithStatus = await Promise.all(
            data.devices.map(async (device) => {
                try {
                    const latestRes = await fetch(`/api/latest/${device.uid}`);
                    const latestData = await latestRes.json();
                    
                    // Determine if device is online based on latest data
                    const isOnline = Array.isArray(latestData) && latestData.length > 0;
                    const lastSeen = isOnline ? latestData[0].timestamp : null;
                    
                    return {
                        ...device,
                        isOnline,
                        lastSeen,
                        sensorCount: isOnline ? latestData.length : 0,
                        latestData: latestData
                    };
                } catch (e) {
                    return {
                        ...device,
                        isOnline: false,
                        lastSeen: null,
                        sensorCount: 0,
                        latestData: []
                    };
                }
            })
        );
        
        renderDevices(devicesWithStatus);
        
    } catch (e) {
        console.error('Failed to load devices:', e);
        loadingState.innerHTML = '<p style="color: #e53935;">Error loading devices. Please try again.</p>';
    }
}

function renderDevices(devices) {
    const container = document.getElementById('devicesContainer');
    
    container.innerHTML = devices.map(device => {
        const statusClass = device.isOnline ? 'online' : 'offline';
        const statusText = device.isOnline ? 'Online' : 'Offline';
        
        // Using shared utility function
        const lastSeenText = device.lastSeen ? new Date(device.lastSeen).toLocaleString() : 'Never';
        
        // Get sensor readings
        let tempValue = '--';
        let moistureValue = '--';
        let lightValue = '--';
        
        if (device.latestData && Array.isArray(device.latestData)) {
            const temp = device.latestData.find(s => s.sensor_type === 'temperature');
            const moisture = device.latestData.find(s => s.sensor_type === 'moisture');
            const light = device.latestData.find(s => s.sensor_type === 'light');
            
            if (temp) tempValue = temp.sensor_value.toFixed(1);
            if (moisture) moistureValue = moisture.sensor_value.toFixed(1);
            if (light) lightValue = Math.round(light.sensor_value);
        }
        
        return `
            <div class="page-card ${device.isOnline ? '' : 'offline'}">
                <div class="page-header">
                    <div>
                        <h3 class="page-name">${device.name || device.uid}</h3>
                        <span class="device-uid">${device.uid}</span>
                    </div>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                
                <div class="device-stats">
                    <div class="stat-item">
                        <div class="stat-icon">üå°Ô∏è</div>
                        <div class="stat-value">${tempValue}</div>
                        <div class="stat-label">Temp ¬∞C</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">üíß</div>
                        <div class="stat-value">${moistureValue}</div>
                        <div class="stat-label">Moisture %</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">‚òÄÔ∏è</div>
                        <div class="stat-value">${lightValue}</div>
                        <div class="stat-label">Light lux</div>
                    </div>
                </div>
                
                <div class="device-info">
                    <strong>Last Seen:</strong> ${lastSeenText}
                </div>
                <div class="device-info">
                    <strong>Active Sensors:</strong> ${device.sensorCount}
                </div>
                
                <div class="device-actions">
                    <button onclick="viewDevice('${device.uid}')">View Dashboard</button>
                    <button class="btn-secondary" onclick="viewHistory('${device.uid}')">History</button>
                </div>
            </div>
        `;
    }).join('');
}

// ============================================
// ADD DEVICE MODAL FUNCTIONS
// ============================================
async function openAddDeviceModal() {
    document.getElementById('addDeviceModal').style.display = 'block';
    document.getElementById('addDeviceForm').reset();
    document.getElementById('formError').style.display = 'none';
    document.getElementById('formSuccess').style.display = 'none';

    // Populate sites dropdown
    const siteSelect = document.getElementById('siteId');
    siteSelect.innerHTML = '<option value="">Loading sites...</option>'; // Loading state
    try {
        const response = await fetch('/api/sites');
        if (!response.ok) throw new Error('Failed to fetch sites');

        const sites = await response.json();
        siteSelect.innerHTML = '<option value="">Select a site (optional)</option>'; // Reset with placeholder
        sites.forEach(site => {
            const option = document.createElement('option');
            option.value = site.id;  // Use 'id' field from your API response
            option.textContent = site.friendly_name || site.id;  // Use 'name' or fallback to id
            siteSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error fetching sites:', error);
        siteSelect.innerHTML = '<option value="">Sites unavailable</option>';
    }

}

function closeAddDeviceModal() {
    document.getElementById('addDeviceModal').style.display = 'none';
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('addDeviceModal');
    if (event.target === modal) {
        closeAddDeviceModal();
    }
}

// Handle form submission
document.getElementById('addDeviceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formError = document.getElementById('formError');
    const formSuccess = document.getElementById('formSuccess');
    const submitBtn = document.getElementById('submitBtn');
    
    // Hide previous messages
    formError.style.display = 'none';
    formSuccess.style.display = 'none';
    
    // Get form data
    const uid = document.getElementById('deviceUid').value.trim();
    const name = document.getElementById('deviceName').value.trim() || null;
    const siteId = document.getElementById('siteId').value ? parseInt(document.getElementById('siteId').value) : null;
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';
    
    try {
        const response = await fetch('/api/device/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                uid: uid,
                name: name,
                site_id: siteId
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Success
            formSuccess.textContent = `Device "${uid}" added successfully!`;
            formSuccess.style.display = 'block';
            
            // Refresh devices list
            setTimeout(() => {
                closeAddDeviceModal();
                loadDevices();
            }, 1500);
            
        } else {
            // Error from server
            formError.textContent = data.detail || 'Failed to add device';
            formError.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add Device';
        }
        
    } catch (error) {
        console.error('Error adding device:', error);
        formError.textContent = 'Network error. Please try again.';
        formError.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Device';
    }
});
</script>

</body>
</html>