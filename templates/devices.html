<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Devices - Smart Allotment</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="/static/js/scripts.js"></script>
</head>

<body>

<header>
    <h1>üå± Smart Allotment - Devices</h1>
</header>

<nav>
    <div class="nav-links">
        <a href="/">üìä Dashboard</a>
        <a href="/devices" class="active">üì° Devices</a>
        <a href="/sites">üè° Sites</a>
        <a href="/sensors">üîß Sensors</a>
        {% if user.role == 'sys_admin' %}
        <a href="/users">üë§ Users</a>
        {% endif %}
    </div>
    <div class="nav-user">
        <span class="user-info">
            <strong>{{ user.full_name or user.username }}</strong>
            {% if user.role == 'sys_admin' %}
            <span class="user-role-badge">Admin</span>
            {% endif %}
        </span>
        <button onclick="logout()" class="btn-secondary">Logout</button>
    </div>  
</nav>

<main>

    <div class="page-selector">
        <div style="flex: 1;">
            <h2 style="margin: 0; font-size: 20px;">üì° Device Management</h2>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Monitor and manage all your allotment sensors</p>
        </div>
        {% if user.role == 'sys_admin' %}
        <button onclick="openAddDeviceModal()" style="margin-right: 10px;">+ Add Device</button>
        {% endif %}
        <button onclick="window.location.href='/'">‚Üê Back to Dashboard</button>
    </div>

    <div id="devicesContainer" class="page-grid"></div>

    <div id="loadingState" class="latest-box" style="text-align: center;">
        <p>Loading devices...</p>
    </div>

    <div id="emptyState" class="latest-box" style="text-align: center; display: none;">
        <h3>No Devices Found</h3>
        <p>No devices have been registered yet.</p>
    </div>

    <!-- Add Device Modal -->
    <div id="addDeviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Device</h3>
                <span class="modal-close" onclick="closeAddDeviceModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addDeviceForm">
                    <div class="form-group">
                        <label for="deviceUid">Device UID <span style="color: #e53935;">*</span></label>
                        <input type="text" id="deviceUid" name="uid" required 
                               placeholder="e.g., SA-NODE2" 
                               pattern="[A-Za-z0-9\-_]+"
                               title="Only letters, numbers, hyphens, and underscores allowed">
                        <small>Unique identifier for the device (required)</small>
                    </div>
                    <div class="form-group">
                        <label for="deviceName">Device Name <span style="color: #e53935;">*</span></label>
                        <input type="text" id="deviceName" name="name" required
                               placeholder="e.g., Garden Bed 1">
                        <small>Friendly name for the device (required)</small>
                    </div>
                    <div class="form-group">
                        <label for="siteId">Site <span style="color: #e53935;">*</span></label>
                        <select id="siteId" name="site_id" required>
                            <option value="">Loading sites...</option>
                        </select>
                        <small>Associated site/location (required)</small>
                    </div>
                    <div id="formError" class="form-error" style="display: none;"></div>
                    <div id="formSuccess" class="form-success" style="display: none;"></div>
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeAddDeviceModal()">Cancel</button>
                        <button type="submit" id="submitBtn">Add Device</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</main>

<script>
const IS_ADMIN = "{{ user.role }}" === "sys_admin";

document.addEventListener('DOMContentLoaded', function() {
    loadDevices();
    setInterval(loadDevices, 30000);
});

async function loadDevices() {
    const container = document.getElementById('devicesContainer');
    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    
    try {
        const res = await fetch('/api/devices');
        const data = await res.json();
        
        if (!data.devices || data.devices.length === 0) {
            container.style.display = 'none';
            loadingState.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }
        
        loadingState.style.display = 'none';
        emptyState.style.display = 'none';
        container.style.display = 'grid';
        
        const devicesWithStatus = await Promise.all(
            data.devices.map(async (device) => {
                try {
                    const latestRes = await fetch(`/api/latest/${device.uid}`);
                    const latestData = await latestRes.json();
                    const isOnline = Array.isArray(latestData) && latestData.length > 0;
                    return {
                        ...device,
                        isOnline,
                        lastSeen: isOnline ? latestData[0].timestamp : null,
                        sensorCount: isOnline ? latestData.length : 0,
                        latestData
                    };
                } catch (e) {
                    return { ...device, isOnline: false, lastSeen: null, sensorCount: 0, latestData: [] };
                }
            })
        );
        
        renderDevices(devicesWithStatus);
        
    } catch (e) {
        console.error('Failed to load devices:', e);
        loadingState.innerHTML = '<p style="color: #e53935;">Error loading devices. Please try again.</p>';
    }
}

function renderDevices(devices) {
    const container = document.getElementById('devicesContainer');
    
    container.innerHTML = devices.map(device => {
        const statusClass = device.isOnline ? 'online' : 'offline';
        const statusText = device.isOnline ? 'Online' : 'Offline';
        const lastSeenText = device.lastSeen ? new Date(device.lastSeen).toLocaleString() : 'Never';
        
        let tempValue = '--', moistureValue = '--', lightValue = '--';
        
        if (device.latestData && Array.isArray(device.latestData)) {
            const temp     = device.latestData.find(s => s.sensor_type === 'temperature');
            const moisture = device.latestData.find(s => s.sensor_type === 'moisture');
            const light    = device.latestData.find(s => s.sensor_type === 'light');
            if (temp)     tempValue     = temp.sensor_value.toFixed(1);
            if (moisture) moistureValue = moisture.sensor_value.toFixed(1);
            if (light)    lightValue    = Math.round(light.sensor_value);
        }

        const readNowBtn = IS_ADMIN
            ? `<button class="btn-secondary" id="readnow-${device.uid}" onclick="triggerReadNow('${device.uid}')">‚ö° Read Now</button>`
            : '';

        const pumpBtn = IS_ADMIN ? `
            <div class="pump-control" id="pump-${device.uid}">
                <button class="btn-pump" onclick="triggerPump('${device.uid}')">üíß Water</button>
                <select class="pump-duration" id="pump-duration-${device.uid}">
                    <option value="5">5s</option>
                    <option value="10">10s</option>
                    <option value="30">30s</option>
                    <option value="60">60s</option>
                    <option value="120">120s</option>
                </select>
            </div>` : '';
        
        return `
            <div class="page-card ${device.isOnline ? '' : 'offline'}">
                <div class="page-header">
                    <div>
                        <h3 class="page-name">${device.name || device.uid}</h3>
                        <span class="device-uid">${device.uid}</span>
                    </div>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                
                <div class="device-stats">
                    <div class="stat-item">
                        <div class="stat-icon">üå°Ô∏è</div>
                        <div class="stat-value">${tempValue}</div>
                        <div class="stat-label">Temp ¬∞C</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">üíß</div>
                        <div class="stat-value">${moistureValue}</div>
                        <div class="stat-label">Moisture %</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">‚òÄÔ∏è</div>
                        <div class="stat-value">${lightValue}</div>
                        <div class="stat-label">Light lux</div>
                    </div>
                </div>
                
                <div class="device-info"><strong>Last Seen:</strong> ${lastSeenText}</div>
                <div class="device-info"><strong>Active Sensors:</strong> ${device.sensorCount}</div>
                
                <div class="device-actions">
                    <button onclick="viewDevice('${device.uid}')">View Dashboard</button>
                    <button class="btn-secondary" onclick="viewHistory('${device.uid}')">History</button>
                    ${readNowBtn}
                    ${pumpBtn}
                </div>
            </div>
        `;
    }).join('');
}

// ============================================
// READ NOW
// ============================================
async function triggerReadNow(deviceUid) {
    const btn = document.getElementById(`readnow-${deviceUid}`);
    const originalText = btn.textContent;

    btn.disabled = true;
    btn.textContent = '‚è≥ Sending...';

    try {
        const res = await fetch(`/api/devices/${deviceUid}/read-now`, { method: 'POST' });
        const data = await res.json();

        if (res.ok) {
            btn.textContent = '‚úÖ Sent!';
            btn.style.background = '#2e7d32';
            setTimeout(() => loadDevices(), 5000);
        } else {
            btn.textContent = '‚ùå Failed';
            btn.style.background = '#e53935';
            console.error('Read now failed:', data.detail);
        }
    } catch (e) {
        btn.textContent = '‚ùå Error';
        btn.style.background = '#e53935';
        console.error('Read now error:', e);
    }

    setTimeout(() => {
        btn.disabled = false;
        btn.textContent = originalText;
        btn.style.background = '';
    }, 3000);
}

// ============================================
// PUMP CONTROL
// ============================================
async function triggerPump(deviceUid) {
    const btn = document.querySelector(`#pump-${deviceUid} .btn-pump`);
    const durationSelect = document.getElementById(`pump-duration-${deviceUid}`);
    const seconds = parseInt(durationSelect.value);
    const originalText = btn.textContent;

    btn.disabled = true;
    btn.textContent = '‚è≥ Sending...';

    try {
        const res = await fetch(`/api/devices/${deviceUid}/pump`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'run', seconds })
        });
        const data = await res.json();

        if (res.ok) {
            btn.textContent = `üö∞ Running ${seconds}s`;
            btn.style.background = '#1565c0';
            // Re-enable after the pump run completes + 1s buffer
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = originalText;
                btn.style.background = '';
            }, (seconds + 1) * 1000);
        } else {
            btn.textContent = '‚ùå Failed';
            btn.style.background = '#e53935';
            console.error('Pump failed:', data.detail);
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = originalText;
                btn.style.background = '';
            }, 3000);
        }
    } catch (e) {
        btn.textContent = '‚ùå Error';
        btn.style.background = '#e53935';
        console.error('Pump error:', e);
        setTimeout(() => {
            btn.disabled = false;
            btn.textContent = originalText;
            btn.style.background = '';
        }, 3000);
    }
}

// ============================================
// ADD DEVICE MODAL
// ============================================
async function openAddDeviceModal() {
    document.getElementById('addDeviceModal').style.display = 'block';
    document.getElementById('addDeviceForm').reset();
    document.getElementById('formError').style.display = 'none';
    document.getElementById('formSuccess').style.display = 'none';

    const siteSelect = document.getElementById('siteId');
    siteSelect.innerHTML = '<option value="">Loading sites...</option>';
    try {
        const response = await fetch('/api/sites');
        const apiData = await response.json();
        const sites = apiData?.sites || [];
        siteSelect.innerHTML = '<option value="">Select a site</option>';
        if (Array.isArray(sites) && sites.length > 0) {
            sites.forEach(site => {
                const option = document.createElement('option');
                option.value = site.id;
                option.textContent = site.friendly_name || site.id;
                siteSelect.appendChild(option);
            });
        } else {
            siteSelect.innerHTML = '<option value="">No sites available</option>';
        }
    } catch (error) {
        siteSelect.innerHTML = '<option value="">Sites unavailable</option>';
    }
}

function closeAddDeviceModal() {
    document.getElementById('addDeviceModal').style.display = 'none';
}

window.onclick = function(event) {
    const modal = document.getElementById('addDeviceModal');
    if (event.target === modal) closeAddDeviceModal();
}

document.getElementById('addDeviceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formError = document.getElementById('formError');
    const formSuccess = document.getElementById('formSuccess');
    const submitBtn = document.getElementById('submitBtn');
    
    formError.style.display = 'none';
    formSuccess.style.display = 'none';
    
    const uid    = document.getElementById('deviceUid').value.trim();
    const name   = document.getElementById('deviceName').value.trim() || null;
    const siteId = document.getElementById('siteId').value ? parseInt(document.getElementById('siteId').value) : null;
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';
    
    try {
        const response = await fetch('/api/device/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uid, name, site_id: siteId })
        });
        const data = await response.json();
        
        if (response.ok) {
            formSuccess.textContent = `Device "${uid}" added successfully!`;
            formSuccess.style.display = 'block';
            setTimeout(() => { closeAddDeviceModal(); loadDevices(); }, 1500);
        } else {
            formError.textContent = data.detail || 'Failed to add device';
            formError.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add Device';
        }
    } catch (error) {
        formError.textContent = 'Network error. Please try again.';
        formError.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Device';
    }
});
</script>

</body>
</html>